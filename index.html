<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Finan√ßas ‚Äî v15</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --bg:#0f172a;        /* slate-900 */
  --panel:#111827;     /* gray-900 */
  --card:#0b1220;      /* darker */
  --text:#e5e7eb;      /* gray-200 */
  --muted:#9ca3af;     /* gray-400 */
  --primary:#10b981;   /* emerald-500 */
  --accent:#22d3ee;    /* cyan-400 */
  --danger:#ef4444;    /* red-500 */
  --sidebar:#0b1220;
  --kpi:#0b2230;
  --shadow: 0 10px 18px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--text);font-family:Inter,system-ui,Arial,sans-serif}
a{color:var(--accent);text-decoration:none}
small.muted{color:var(--muted)}
.wrap{display:flex;min-height:100vh}
aside{width:260px;background:var(--sidebar);padding:18px;position:sticky;top:0;height:100vh;border-right:1px solid rgba(255,255,255,.06)}
aside .logo{font-weight:700;letter-spacing:.5px;margin-bottom:18px;display:flex;align-items:center;gap:8px}
.nav a{display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:10px;color:var(--text);opacity:.85}
.nav a.active,.nav a:hover{background:rgba(255,255,255,.06);opacity:1}
.nav svg{width:18px;height:18px;opacity:.9}
main{flex:1;padding:22px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
.card h3{margin:0 0 10px 0;font-size:16px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin:8px 0 6px}
.kpi{background:rgba(16,185,129,.09);border:1px solid rgba(16,185,129,.25);border-radius:16px;padding:14px;display:flex;align-items:center;gap:12px;min-height:78px}
.kpi .icon{width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center}
.kpi .val{font-weight:700;font-size:20px}
.kpi .label{color:var(--muted);font-size:12px}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select,input,button,textarea{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);color:var(--text);padding:8px 10px;border-radius:10px}
button{cursor:pointer}
.btn.primary{background:var(--primary);border-color:var(--primary);color:#001b12;font-weight:600}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px 6px;text-align:left;font-size:13px}
.badge{padding:3px 8px;border-radius:100px;border:1px solid rgba(255,255,255,.2);font-size:11px;color:var(--muted)}
footer{margin-top:20px;text-align:right;color:var(--muted);font-size:12px}
.pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12)}
/* Sidebar toggle (compact) */
aside.compact{width:76px}
aside.compact .txt{display:none}
.compact .logo span{display:none}
.compact .nav a{justify-content:center}
.compact main{margin-left:76px}
.topbar{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.topbar .spacer{flex:1}
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;font-size:12px}
/* Calendar */
.cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cal .cell{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:10px;min-height:66px;padding:6px;position:relative}
.cal .day{position:absolute;top:6px;right:8px;color:var(--muted);font-size:11px}
.tag{display:inline-block;padding:2px 6px;border-radius:8px;font-size:10px}
.tag.exp{background:rgba(239,68,68,.18);border:1px solid rgba(239,68,68,.35)}
.tag.inc{background:rgba(34,197,94,.2);border:1px solid rgba(34,197,94,.4)}
/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:10px}
.tabs button{padding:8px 10px}
.tabs button.active{background:rgba(255,255,255,.12)}
/* Status cloud pill */
#pillCloud{margin-left:auto}
</style>
</head>
<body>
<div class="wrap">
  <aside id="sb">
    <div class="logo">
      <button id="btnCollapse" title="Recolher menu" style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:10px;width:36px;height:36px;display:flex;align-items:center;justify-content:center">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 18l-6-6 6-6"/></svg>
      </button>
      <span>Finan√ßas</span>
    </div>
    <nav class="nav">
      <a href="#dash" data-nav="dash" class="active">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
        <span class="txt">Dashboard</span>
      </a>
      <a href="#lancar" data-nav="lancar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 5v14M5 12h14"/></svg>
        <span class="txt">Lan√ßar</span>
      </a>
      <a href="#demo" data-nav="demo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><path d="M14.31 8l5.74 9.94M9.69 8h11.48M7.38 12l5.74-9.94M9.69 16L3.95 6.06"/></svg>
        <span class="txt">Demonstrativo</span>
      </a>
      <a href="#parc" data-nav="parc">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M3 10h18"/></svg>
        <span class="txt">Parcelados</span>
      </a>
      <a href="#cfg" data-nav="cfg">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h0A1.65 1.65 0 0 0 9 3.09V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h0a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v0A1.65 1.65 0 0 0 21 11h.09a2 2 0 1 1 0 4H21a1.65 1.65 0 0 0-1.51 1Z"/></svg>
        <span class="txt">Config</span>
      </a>
    </nav>
  </aside>

  <main>
    <div class="topbar">
      <div class="toolbar">
        <label>Per√≠odo:</label>
        <select id="selMes"></select>
        <span class="pill mono" id="pillCloud"><span class="muted">Cloud:</span> <span id="pillCloudTxt">offline</span></span>
      </div>
      <div class="spacer"></div>
    </div>

    <section id="dash" class="page">
      <div class="kpis">
        <div class="kpi"><div class="icon">üí∞</div><div><div class="label">Saldo estimado</div><div class="val" id="kSaldo">R$ 0,00</div></div></div>
        <div class="kpi"><div class="icon">üìâ</div><div><div class="label">Despesas</div><div class="val" id="kDesp">R$ 0,00</div></div></div>
        <div class="kpi"><div class="icon">üìà</div><div><div class="label">Receitas</div><div class="val" id="kRec">R$ 0,00</div></div></div>
        <div class="kpi"><div class="icon">üè¶</div><div><div class="label">Parcelados (m√™s)</div><div class="val" id="kParc">R$ 0,00</div></div></div>
      </div>

      <div class="row">
        <div class="card">
          <h3>Resumo do m√™s</h3>
          <table class="table" id="tblResumo"></table>
        </div>
        <div class="card">
          <h3>Calend√°rio</h3>
          <div class="cal" id="cal"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Distribui√ß√£o das Despesas</h3>
        <canvas id="pie" height="160"></canvas>
        <h3 style="margin-top:12px">Evolu√ß√£o di√°ria ‚Ä¢ Despesas vs Receitas</h3>
        <canvas id="line" height="160"></canvas>
      </div>
      <footer>v15</footer>
    </section>

    <section id="lancar" class="page" style="display:none">
      <div class="card">
        <h3>Lan√ßar planejado (m√™s atual)</h3>
        <div class="row">
          <div><label>Tipo</label><br/><select id="tipSel">
            <option value="fixas">Gastos Fixos</option>
            <option value="variaveis">Gastos Vari√°veis</option>
            <option value="invest">Investimentos</option>
            <option value="receitas">Receitas</option>
          </select></div>
          <div><label>Categoria</label><br/><select id="catSel"></select></div>
        </div>
        <div class="row">
          <div><label>Subcategoria</label><br/><select id="subSel"></select></div>
          <div><label>Valor (R$)</label><br/><input id="valInp" type="number" step="0.01" placeholder="0,00"/></div>
        </div>
        <div class="toolbar" style="margin-top:8px">
          <button class="btn primary" id="btnAdd">Adicionar</button>
          <small class="muted">Os itens entram no m√™s selecionado acima.</small>
        </div>
      </div>

      <div class="card">
        <h3>Itens do m√™s</h3>
        <table class="table" id="tblItens"></table>
      </div>
    </section>

    <section id="demo" class="page" style="display:none">
      <div class="row">
        <div class="card"><h3>Gastos Fixos</h3><table class="table" id="dFixas"></table></div>
        <div class="card"><h3>Gastos Vari√°veis</h3><table class="table" id="dVars"></table></div>
      </div>
      <div class="row" style="margin-top:12px">
        <div class="card"><h3>Investimentos</h3><table class="table" id="dInv"></table></div>
        <div class="card"><h3>Receitas</h3><table class="table" id="dRec"></table></div>
      </div>
      <div class="card" style="margin-top:12px"><h3>Parcelados (m√™s)</h3><table class="table" id="dParc"></table></div>
    </section>

    <section id="parc" class="page" style="display:none">
      <div class="card">
        <h3>Novo contrato parcelado</h3>
        <div class="row">
          <div><label>Descri√ß√£o</label><br/><input id="pcDesc" placeholder="Ex.: Financiamento carro"/></div>
          <div><label>In√≠cio</label><br/><input id="pcIni" type="date"/></div>
        </div>
        <div class="row">
          <div><label>Dia de vencimento</label><br/><input id="pcDia" type="number" min="1" max="31" placeholder="10"/></div>
          <div><label>Valor da parcela (R$)</label><br/><input id="pcVal" type="number" step="0.01"/></div>
        </div>
        <div class="row">
          <div><label>Quantidade de parcelas</label><br/><input id="pcQtd" type="number" min="1"/></div>
          <div style="display:flex;align-items:end"><button class="btn primary" id="btnPcAdd">Salvar contrato</button></div>
        </div>
      </div>
      <div class="card">
        <h3>Contratos</h3>
        <table class="table" id="tblContratos"></table>
      </div>
    </section>

    <section id="cfg" class="page" style="display:none">
      <div class="tabs">
        <button class="btn tab active" data-tab="tCateg">Categorias</button>
        <button class="btn tab" data-tab="tCloud">Nuvem</button>
        <button class="btn tab" data-tab="tConta">Conta</button>
        <button class="btn tab" data-tab="tHH">Household</button>
      </div>

      <div id="tCateg" class="tabpane">
        <div class="card">
          <h3>Categorias & Subcategorias</h3>
          <small class="muted">Edite a lista. Cada linha √© uma categoria. Subcategorias separadas por v√≠rgula.</small>
          <div class="row" style="margin-top:8px">
            <div>
              <label>Despesas (usado em Fixos e Vari√°veis)</label><br/>
              <textarea id="taDespesas" rows="8" style="width:100%"></textarea>
            </div>
            <div>
              <label>Subcategorias de Despesas</label><br/>
              <textarea id="taSubDespesas" rows="8" style="width:100%"></textarea>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Investimentos</label><br/>
              <textarea id="taInv" rows="4" style="width:100%"></textarea>
            </div>
            <div>
              <label>Receitas</label><br/>
              <textarea id="taRec" rows="4" style="width:100%"></textarea>
            </div>
          </div>
          <div class="toolbar">
            <button class="btn primary" id="btnSaveCfg">Salvar categorias</button>
            <span class="badge">As categorias ficam salvas localmente e, se logado no household, tamb√©m na nuvem.</span>
          </div>
        </div>
      </div>

      <div id="tCloud" class="tabpane" style="display:none">
        <div class="card">
          <h3>Nuvem (Supabase)</h3>
          <div class="row">
            <div><label>Supabase URL</label><br/><input id="spUrl" placeholder="https://xxxx.supabase.co"/></div>
            <div><label>Supabase anon key</label><br/><input id="spKey" placeholder="eyJ..."/></div>
          </div>
          <div class="toolbar">
            <button class="btn" id="btnSpSave">Salvar config</button>
            <button class="btn" id="btnSpTest">Testar conex√£o</button>
            <button class="btn" id="btnSpDiag">Diagnosticar</button>
            <span class="pill"><span class="muted">Status:</span> <span id="spStatus">Desconectado</span></span>
          </div>
        </div>
      </div>

      <div id="tConta" class="tabpane" style="display:none">
        <div class="card">
          <h3>Conta</h3>
          <div class="row">
            <div><label>E-mail</label><br/><input id="spEmail" type="email"/></div>
            <div><label>Senha</label><br/><input id="spPass" type="password"/></div>
          </div>
          <div class="toolbar">
            <button class="btn primary" id="btnSpSignIn">Entrar</button>
            <button class="btn" id="btnSpSignUp">Criar conta</button>
            <button class="btn" id="btnSpSignOut">Sair</button>
            <span class="badge" id="authStatus">N√£o autenticado</span>
          </div>
        </div>
      </div>

      <div id="tHH" class="tabpane" style="display:none">
        <div class="card">
          <h3>Espa√ßo da fam√≠lia (Household)</h3>
          <div class="row">
            <div><label>Nome do espa√ßo</label><br/><input id="hhName" placeholder="Fam√≠lia Silva"/></div>
            <div><label>Passcode</label><br/><input id="hhPass" placeholder="AB1234"/></div>
          </div>
          <div class="toolbar">
            <button class="btn primary" id="btnCreateHH">Criar Household</button>
            <span class="muted">ou</span>
            <input id="joinId" placeholder="ID do Household" style="min-width:260px"/>
            <input id="joinPass" placeholder="Passcode"/>
            <button class="btn" id="btnJoinHH">Entrar com c√≥digo</button>
            <span class="pill"><span class="muted">Atual:</span> <code id="hhCurrent" class="mono">‚Äî</code></span>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
/* ===== util ===== */
const brl = v => (v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const ymd = d => d.toISOString().slice(0,10);
const ym = d => d.toISOString().slice(0,7);
function fillSelMes(){
  const sel = document.getElementById('selMes'); sel.innerHTML='';
  const base = new Date(); base.setDate(1);
  for(let i=-5;i<=7;i++){
    const dt = new Date(base.getFullYear(), base.getMonth()+i, 1);
    const v = dt.toISOString().slice(0,7);
    const opt = document.createElement('option'); opt.value=v; opt.textContent=v;
    if(i===0) opt.selected=true;
    sel.appendChild(opt);
  }
}
fillSelMes();

/* ===== state ===== */
let app = {
  atual: document.getElementById('selMes').value,
  cfg: {
    categorias: {
      despesas: ["Alimenta√ß√£o","Moradia","Transporte","Sa√∫de","Educa√ß√£o","Lazer","Contas","Outros"],
      investimentos: ["Reserva Emerg√™ncia","Aportes","Poupan√ßa"],
      receitas: ["Sal√°rio","Pr√≥-labore","Bicos","Outras"]
    },
    subcats: {
      despesas: ["Supermercado","Restaurante","Delivery","Aluguel","Condom√≠nio","Luz","√Ågua","Internet","Combust√≠vel","Manuten√ß√£o","Farm√°cia","Plano de Sa√∫de"],
      investimentos: ["Tesouro","CDB","Fundos","A√ß√µes"],
      receitas: ["Principal","13¬∫","B√¥nus"]
    }
  },
  meses: {},    // { 'YYYY-MM': [ {tipo,categoria,subcategoria,valor} ] }
  diario: {},   // { 'YYYY-MM-DD': [ {tipo,categoria,subcategoria,valor} ] }
  parcelados: []// [ {id,descricao,data_ini,venc_dia,valor_parcela,qtd_parcelas} ]
};

function saveLocal(){ localStorage.setItem('fin_app', JSON.stringify(app)); }
function loadLocal(){
  try{ const j = JSON.parse(localStorage.getItem('fin_app')||'{}'); if(j && j.cfg) app = Object.assign(app, j); }catch(e){}
}
loadLocal();

/* ===== UI nav/tabs ===== */
document.querySelectorAll('.nav a').forEach(a=>a.addEventListener('click',e=>{
  e.preventDefault();
  const tgt=a.dataset.nav;
  document.querySelectorAll('.nav a').forEach(n=>n.classList.remove('active'));
  a.classList.add('active');
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  ({dash:'#dash',lancar:'#lancar',demo:'#demo',parc:'#parc',cfg:'#cfg'})[tgt] && (document.querySelector(({dash:'#dash',lancar:'#lancar',demo:'#demo',parc:'#parc',cfg:'#cfg'})[tgt]).style.display='block');
}));

document.getElementById('btnCollapse').onclick = ()=>{
  const sb = document.getElementById('sb'); sb.classList.toggle('compact');
  localStorage.setItem('sb_compact', sb.classList.contains('compact')?'1':'0');
};
if(localStorage.getItem('sb_compact')==='1') document.getElementById('sb').classList.add('compact');

/* ===== Config: categorias ===== */
function loadCfgToUI(){
  const c = app.cfg.categorias, s = app.cfg.subcats;
  document.getElementById('taDespesas').value = (c.despesas||[]).join('\\n');
  document.getElementById('taSubDespesas').value = (s.despesas||[]).join('\\n');
  document.getElementById('taInv').value = (c.investimentos||[]).join('\\n');
  document.getElementById('taRec').value = (c.receitas||[]).join('\\n');
}
function applyCfgFromUI(){
  app.cfg.categorias.despesas = document.getElementById('taDespesas').value.split(/\\n+/).map(x=>x.trim()).filter(Boolean);
  app.cfg.subcats.despesas     = document.getElementById('taSubDespesas').value.split(/\\n+/).map(x=>x.trim()).filter(Boolean);
  app.cfg.categorias.investimentos = document.getElementById('taInv').value.split(/\\n+/).map(x=>x.trim()).filter(Boolean);
  app.cfg.categorias.receitas = document.getElementById('taRec').value.split(/\\n+/).map(x=>x.trim()).filter(Boolean);
  saveLocal(); renderForm();
}
document.getElementById('btnSaveCfg').onclick = ()=>{ applyCfgFromUI(); alert('Categorias salvas.'); };

function renderForm(){
  const tipSel = document.getElementById('tipSel');
  const catSel = document.getElementById('catSel');
  const subSel = document.getElementById('subSel');
  const t=tipSel.value;
  const cats = t==='invest' ? app.cfg.categorias.investimentos : (t==='receitas' ? app.cfg.categorias.receitas : app.cfg.categorias.despesas);
  catSel.innerHTML = cats.map(x=>`<option>${x}</option>`).join('');
  const subs = t==='invest' ? (app.cfg.subcats.investimentos||[]) : (t==='receitas'? (app.cfg.subcats.receitas||[]) : app.cfg.subcats.despesas);
  subSel.innerHTML = subs.map(x=>`<option>${x}</option>`).join('');
}
document.getElementById('tipSel').onchange = renderForm;
loadCfgToUI(); renderForm();

/* ===== Lan√ßar ===== */
function renderLista(){
  const list = app.meses[app.atual]||[];
  const el = document.getElementById('tblItens');
  const rows = list.map((x,i)=>`<tr>
    <td><span class="badge">${x.tipo}</span></td>
    <td>${x.categoria||''}</td>
    <td>${x.subcategoria||''}</td>
    <td>${brl(x.valor)}</td>
    <td><button class="btn" data-del="${i}">Excluir</button></td>
  </tr>`).join('');
  el.innerHTML = `<tr><th>Tipo</th><th>Categoria</th><th>Subcategoria</th><th>Valor</th><th></th></tr>${rows}`;
  el.querySelectorAll('button[data-del]').forEach(b=>b.onclick=()=>{
    const idx = +b.getAttribute('data-del');
    (app.meses[app.atual]||[]).splice(idx,1); saveLocal(); renderLista(); renderDashboard(); renderDemo(); renderCharts();
  });
}
document.getElementById('btnAdd').onclick = async ()=>{
  const t = document.getElementById('tipSel').value;
  const c = document.getElementById('catSel').value;
  const s = document.getElementById('subSel').value;
  const v = parseFloat(document.getElementById('valInp').value||'0');
  if(!v || v<=0){ alert('Informe um valor.'); return; }
  app.meses[app.atual] = app.meses[app.atual]||[];
  app.meses[app.atual].push({tipo:t,categoria:c,subcategoria:s,valor:v});
  saveLocal(); renderLista(); renderDashboard(); renderDemo(); renderCharts();
  // cloud
  if(sp.client && sp.session && sp.household_id){
    await spInsertTransaction({ ref_month: app.atual, tipo:t, categoria:c, subcategoria:s, valor:v });
  }
};

/* ===== Dashboard ===== */
function calcResumo(){
  const arr = app.meses[app.atual]||[];
  let fix=0,varv=0,inv=0,rec=0;
  arr.forEach(x=>{
    if(x.tipo==='fixas') fix+=x.valor;
    else if(x.tipo==='variaveis') varv+=x.valor;
    else if(x.tipo==='invest') inv+=x.valor;
    else if(x.tipo==='receitas') rec+=x.valor;
  });
  // Parcelados m√™s (soma das parcelas do m√™s corrente)
  let parcMes=0;
  const m = app.atual;
  app.parcelados.forEach(ct=>{
    for(let i=0;i<ct.qtd_parcelas;i++){
      const d = new Date(ct.data_ini); d.setMonth(d.getMonth()+i);
      const venc = new Date(d.getFullYear(), d.getMonth(), ct.venc_dia);
      const mk = venc.toISOString().slice(0,7);
      if(mk===m) parcMes += +ct.valor_parcela;
    }
  });
  return {fix,varv,inv,rec,parcMes, saldo: (rec - (fix+varv+inv+parcMes))};
}

function renderDashboard(){
  const r = calcResumo();
  document.getElementById('kSaldo').textContent = brl(r.saldo);
  document.getElementById('kDesp').textContent  = brl(r.fix + r.varv + r.parcMes + r.inv);
  document.getElementById('kRec').textContent   = brl(r.rec);
  document.getElementById('kParc').textContent  = brl(r.parcMes);
  const tbl = document.getElementById('tblResumo');
  tbl.innerHTML = `<tr><th>Grupo</th><th>Total</th></tr>
    <tr><td>Fixos</td><td>${brl(r.fix)}</td></tr>
    <tr><td>Vari√°veis</td><td>${brl(r.varv)}</td></tr>
    <tr><td>Parcelados (m√™s)</td><td>${brl(r.parcMes)}</td></tr>
    <tr><td>Investimentos</td><td>${brl(r.inv)}</td></tr>
    <tr><td>Receitas</td><td>${brl(r.rec)}</td></tr>
    <tr><td><b>Saldo</b></td><td><b>${brl(r.saldo)}</b></td></tr>`;
  renderCalendar();
}
document.getElementById('selMes').onchange = ()=>{ app.atual = document.getElementById('selMes').value; saveLocal(); renderLista(); renderDashboard(); renderDemo(); renderCharts(); spSyncFromCloud && spSyncFromCloud('transactions'); };

/* ===== Calendar (s√≥ exibe totais por dia, lan√ßamentos di√°rios se houver) ===== */
let diaKey = null;
function renderCalendar(){
  const base = new Date(app.atual+'-01T00:00:00');
  const startDay = new Date(base.getFullYear(), base.getMonth(), 1);
  const month = base.getMonth();
  const endDay = new Date(base.getFullYear(), base.getMonth()+1, 0);
  const cells = [];
  // padding do primeiro dia
  const pad = (startDay.getDay()+6)%7; // semana come√ßando em segunda
  for(let i=0;i<pad;i++) cells.push('<div></div>');
  for(let d=1; d<=endDay.getDate(); d++){
    const k = app.atual+'-'+String(d).padStart(2,'0');
    const list = app.diario[k]||[];
    const gDesp = list.filter(x=>x.tipo!=='receitas' && x.tipo!=='invest').reduce((a,b)=>a+b.valor,0);
    const gRec  = list.filter(x=>x.tipo==='receitas').reduce((a,b)=>a+b.valor,0);
    cells.push(`<div class="cell" data-day="${k}">
      <div class="day">${d}</div>
      ${gDesp?`<span class="tag exp">- ${brl(gDesp)}</span>`:''}
      ${gRec?` <span class="tag inc">+ ${brl(gRec)}</span>`:''}
    </div>`);
  }
  const el = document.getElementById('cal');
  el.innerHTML = cells.join('');
  el.querySelectorAll('.cell[data-day]').forEach(c=>c.onclick = ()=>{
    diaKey = c.getAttribute('data-day');
    alert('Dia selecionado: '+diaKey+' (lan√ßamentos di√°rios vir√£o numa pr√≥xima etapa)');
  });
}

/* ===== Demonstrativo ===== */
function group(list){ return list.reduce((acc,x)=>{ const k=(x.categoria||'‚Äî')+' / '+(x.subcategoria||'‚Äî'); acc[k]=(acc[k]||0)+x.valor; return acc; },{}); }
function tableFromGroup(g){ const rows = Object.entries(g).map(([k,v])=>`<tr><td>${k}</td><td>${brl(v)}</td></tr>`).join(''); return `<tr><th>Categoria / Sub</th><th>Total</th></tr>${rows||''}`; }
function renderDemo(){
  const arr = app.meses[app.atual]||[];
  const fix = group(arr.filter(x=>x.tipo==='fixas'));
  const vrs = group(arr.filter(x=>x.tipo==='variaveis'));
  const inv = group(arr.filter(x=>x.tipo==='invest'));
  const rec = group(arr.filter(x=>x.tipo==='receitas'));
  document.getElementById('dFixas').innerHTML = tableFromGroup(fix);
  document.getElementById('dVars').innerHTML = tableFromGroup(vrs);
  document.getElementById('dInv').innerHTML  = tableFromGroup(inv);
  document.getElementById('dRec').innerHTML  = tableFromGroup(rec);
  // Parcelados m√™s
  const r = calcResumo();
  document.getElementById('dParc').innerHTML = `<tr><th>Parcela do m√™s</th><th>Total</th></tr><tr><td>Somat√≥rio</td><td>${brl(r.parcMes)}</td></tr>`;
}

/* ===== Parcelados ===== */
function renderParcelados(){
  const el = document.getElementById('tblContratos');
  const rows = app.parcelados.map((c,i)=>`<tr>
    <td>${c.descricao}</td>
    <td>${c.data_ini}</td>
    <td>${c.venc_dia}</td>
    <td>${c.qtd_parcelas}</td>
    <td>${brl(c.valor_parcela)}</td>
    <td><button class="btn" data-delc="${c.id||i}">Excluir</button></td>
  </tr>`).join('');
  el.innerHTML = `<tr><th>Descri√ß√£o</th><th>In√≠cio</th><th>Vencimento</th><th>Parcelas</th><th>Valor parcela</th><th></th></tr>${rows}`;
  el.querySelectorAll('button[data-delc]').forEach(b=>b.onclick=async ()=>{
    const id = b.getAttribute('data-delc');
    app.parcelados = app.parcelados.filter(x=>(x.id||'')!==id);
    saveLocal(); renderParcelados(); renderDashboard(); renderDemo();
    if(sp.client && sp.session && sp.household_id){ await spDeleteContract(id); }
  });
}
document.getElementById('btnPcAdd').onclick = async ()=>{
  const c = {
    descricao: document.getElementById('pcDesc').value.trim(),
    data_ini: document.getElementById('pcIni').value,
    venc_dia: parseInt(document.getElementById('pcDia').value||'0',10),
    valor_parcela: parseFloat(document.getElementById('pcVal').value||'0'),
    qtd_parcelas: parseInt(document.getElementById('pcQtd').value||'0',10)
  };
  if(!c.descricao||!c.data_ini||!c.venc_dia||!c.valor_parcela||!c.qtd_parcelas){ alert('Preencha todos os campos.'); return; }
  app.parcelados.push(c); saveLocal(); renderParcelados(); renderDashboard(); renderDemo();
  if(sp.client && sp.session && sp.household_id){
    const row = await spInsertContract(c); if(row){ c.id=row.id; saveLocal(); renderParcelados(); }
  }
};

/* ===== Charts ===== */
let pie=null,line=null;
function renderCharts(){
  const arr = app.meses[app.atual]||[];
  const somaPorCat = {};
  arr.filter(x=>x.tipo!=='receitas' && x.tipo!=='invest').forEach(x=>{ somaPorCat[x.categoria]= (somaPorCat[x.categoria]||0)+x.valor; });
  const pctx = document.getElementById('pie').getContext('2d');
  if(pie) pie.destroy();
  pie = new Chart(pctx, { type:'pie', data:{ labels:Object.keys(somaPorCat), datasets:[{ data:Object.values(somaPorCat) }] } });

  // di√°rio
  const days = []; const dDesp=[]; const dRec=[];
  const base = new Date(app.atual+'-01T00:00:00'); const end = new Date(base.getFullYear(), base.getMonth()+1, 0);
  for(let d=1; d<=end.getDate(); d++){
    const k = app.atual+'-'+String(d).padStart(2,'0');
    days.push(d);
    const list = app.diario[k]||[];
    dDesp.push(list.filter(x=>x.tipo!=='receitas').reduce((a,b)=>a+b.valor,0));
    dRec.push(list.filter(x=>x.tipo==='receitas').reduce((a,b)=>a+b.valor,0));
  }
  const lctx = document.getElementById('line').getContext('2d');
  if(line) line.destroy();
  line = new Chart(lctx, { type:'line', data:{ labels:days, datasets:[{label:'Despesas', data:dDesp},{label:'Receitas', data:dRec}] } });
}

/* ===== Tabs in Config ===== */
document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  document.querySelectorAll('.tabpane').forEach(p=>p.style.display='none');
  document.getElementById(b.dataset.tab).style.display='block';
});

/* ===== SUPABASE INTEGRA√á√ÉO v1 ====== */
let sp = { url:'', key:'', client:null, session:null, household_id:null };

function setCloudStatus(msg){
  const pill = document.getElementById('pillCloudTxt'); if(pill) pill.textContent = msg;
  const st = document.getElementById('spStatus'); if(st) st.textContent = msg.charAt(0).toUpperCase()+msg.slice(1);
}
function spLoadConfig(){
  try{
    const cfg = JSON.parse(localStorage.getItem('sp_cfg')||'{}');
    sp.url = cfg.url||''; sp.key = cfg.key||''; sp.household_id = cfg.hh||cfg.household_id||null;
    if(document.getElementById('spUrl')) document.getElementById('spUrl').value = sp.url;
    if(document.getElementById('spKey')) document.getElementById('spKey').value = sp.key;
    if(document.getElementById('hhCurrent')) document.getElementById('hhCurrent').textContent = sp.household_id||'‚Äî';
  }catch(e){}
}
function spSaveConfig(){ localStorage.setItem('sp_cfg', JSON.stringify({url:sp.url, key:sp.key, household_id:sp.household_id, hh:sp.household_id})); }
function spApplyStatus(){
  if(!sp.client){ setCloudStatus('offline'); return; }
  if(!sp.session){ setCloudStatus('conectado (sem login)'); return; }
  setCloudStatus(sp.household_id ? 'online ‚úì' : 'logado (sem household)');
}
async function spInitClient(){
  if(!sp.url || !sp.key){ sp.client=null; spApplyStatus(); return; }
  sp.client = window.supabase.createClient(sp.url, sp.key);
  const { data } = await sp.client.auth.getSession();
  sp.session = data?.session || null;
  spApplyStatus();
  sp.client?.auth.onAuthStateChange((_event, session)=>{ sp.session = session; spApplyStatus(); });
}
async function spSignIn(email, pass){ const { data, error } = await sp.client.auth.signInWithPassword({email, password:pass}); if(error) throw error; sp.session = data.session; spApplyStatus(); }
async function spSignUp(email, pass){ const { data, error } = await sp.client.auth.signUp({email, password:pass}); if(error) throw error; sp.session = data.session; spApplyStatus(); }
async function spSignOut(){ await sp.client.auth.signOut(); sp.session=null; spApplyStatus(); }

async function spCreateHH(name, passcode){ const { data, error } = await sp.client.rpc('create_household', { p_name:name, p_passcode:passcode }); if(error) throw error; return data; }
async function spJoinHH(id, passcode){ const { data, error } = await sp.client.rpc('join_household', { p_household:id, p_passcode:passcode }); if(error) throw error; return data===true; }

async function spFetchSettings(){ if(!sp.household_id) return null; const { data, error } = await sp.client.from('settings').select('*').eq('household_id', sp.household_id).maybeSingle(); if(error) return null; return data; }
async function spUpsertSettings(cfg){
  if(!sp.household_id) return;
  const payload = { household_id: sp.household_id, categorias: cfg.categorias, subcats: cfg.subcats, updated_at: new Date().toISOString() };
  await sp.client.from('settings').upsert(payload, { onConflict: 'household_id' });
}
async function spFetchContracts(){ if(!sp.household_id) return []; const { data } = await sp.client.from('contracts').select('*').eq('household_id', sp.household_id).order('created_at'); return data||[]; }
async function spInsertContract(c){ const payload = { household_id: sp.household_id, descricao:c.descricao, data_ini:c.data_ini, venc_dia:c.venc_dia, valor_parcela:c.valor_parcela, qtd_parcelas:c.qtd_parcelas }; const { data, error } = await sp.client.from('contracts').insert(payload).select('*').single(); if(error) { alert('Erro ao salvar contrato'); return null; } return data; }
async function spDeleteContract(id){ await sp.client.from('contracts').delete().eq('id', id); }
async function spFetchTransactions(monthKey){
  if(!sp.household_id) return [];
  const { data } = await sp.client.from('transactions').select('*').eq('household_id', sp.household_id).or(`ref_month.eq.${monthKey},and(date.gte.${monthKey}-01,date.lt.${monthKey}-32)`);
  return data||[];
}
async function spInsertTransaction(t){ const payload = { household_id: sp.household_id, ref_month:t.ref_month||null, date:t.date||null, tipo:t.tipo, categoria:t.categoria, subcategoria:t.subcategoria||null, valor:t.valor||0 }; await sp.client.from('transactions').insert(payload); }
async function spDeleteTransaction(id){ await sp.client.from('transactions').delete().eq('id', id); }

let rtChannel = null;
function spSubRealtime(){
  if(!sp.client || !sp.household_id) return;
  if(rtChannel) sp.client.removeChannel(rtChannel);
  rtChannel = sp.client.channel('fin_cloud')
    .on('postgres_changes', { event:'*', schema:'public', table:'contracts', filter:`household_id=eq.${sp.household_id}` }, ()=> spSyncFromCloud('contracts'))
    .on('postgres_changes', { event:'*', schema:'public', table:'transactions', filter:`household_id=eq.${sp.household_id}` }, ()=> spSyncFromCloud('transactions'))
    .subscribe();
}

async function spSyncFromCloud(what){
  if(!sp.client || !sp.household_id) return;
  if(what==='contracts' || what==='all'){
    app.parcelados = await spFetchContracts(); saveLocal(); renderParcelados(); renderDashboard(); renderDemo();
  }
  if(what==='transactions' || what==='all'){
    const t = await spFetchTransactions(app.atual);
    // rebuild mensal (planejado) e di√°rio
    app.meses[app.atual] = t.filter(x=>x.ref_month===app.atual && x.tipo!=='parc').map(x=>({tipo:x.tipo, categoria:x.categoria, subcategoria:x.subcategoria, valor:+x.valor}));
    app.diario = {}; t.filter(x=>x.date).forEach(x=>{ const k=x.date; (app.diario[k]=app.diario[k]||[]).push({tipo:x.tipo,categoria:x.categoria,subcategoria:x.subcategoria,valor:+x.valor}); });
    saveLocal(); renderLista(); renderDashboard(); renderDemo(); renderCharts(); renderCalendar();
  }
}

document.getElementById('btnSpSave').onclick = async ()=>{ sp.url = document.getElementById('spUrl').value.trim(); sp.key = document.getElementById('spKey').value.trim(); spSaveConfig(); await spInitClient(); alert('Config salva.'); };
document.getElementById('btnSpTest').onclick = async ()=>{ await spInitClient(); alert(sp.client?'SDK inicializado: OK':'Preencha URL e Key'); };
document.getElementById('btnSpDiag').onclick = async ()=>{
  await spInitClient(); if(!sp.client){ alert('Sem client'); return; }
  try{ const { error } = await sp.client.from('settings').select('*').limit(1); if(error){ setCloudStatus('conectado (RLS ativo)'); alert('Conex√£o OK; RLS bloqueou leitura (normal sem household)'); } else { setCloudStatus('online ‚úì'); alert('Conex√£o OK.'); } }catch(e){ alert('Erro: '+e.message); }
};
document.getElementById('btnSpSignIn').onclick = async ()=>{ await spInitClient(); try{ await spSignIn(document.getElementById('spEmail').value, document.getElementById('spPass').value); alert('Logado!'); }catch(e){ alert('Erro: '+e.message); } };
document.getElementById('btnSpSignUp').onclick = async ()=>{ await spInitClient(); try{ await spSignUp(document.getElementById('spEmail').value, document.getElementById('spPass').value); alert('Conta criada!'); }catch(e){ alert('Erro: '+e.message); } };
document.getElementById('btnSpSignOut').onclick = async ()=>{ try{ await spSignOut(); alert('Saiu.'); }catch(e){ alert('Erro ao sair'); } };

document.getElementById('btnCreateHH').onclick = async ()=>{
  await spInitClient(); if(!sp.session){ alert('Fa√ßa login antes.'); return; }
  try{ const id = await spCreateHH(document.getElementById('hhName').value.trim(), document.getElementById('hhPass').value.trim()); sp.household_id=id; spSaveConfig(); document.getElementById('hhCurrent').textContent=id; spSubRealtime(); spSyncFromCloud('all'); alert('Household criado!'); }catch(e){ alert('Erro: '+e.message); }
};
document.getElementById('btnJoinHH').onclick = async ()=>{
  await spInitClient(); if(!sp.session){ alert('Fa√ßa login antes.'); return; }
  try{ const id = document.getElementById('joinId').value.trim(); const ok = await spJoinHH(id, document.getElementById('joinPass').value.trim()); if(!ok){ alert('C√≥digo inv√°lido'); return; } sp.household_id=id; spSaveConfig(); document.getElementById('hhCurrent').textContent=id; spSubRealtime(); spSyncFromCloud('all'); alert('Voc√™ entrou no household!'); }catch(e){ alert('Erro: '+e.message); }
};

/* Prefill sua URL/key (s√≥ 1¬™ vez) */
(function prefillSP(){
  const cfg = localStorage.getItem('sp_cfg');
  if(!cfg){
    sp.url='https://uvygqjwtxyrknkfoozwx.supabase.co';
    sp.key='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2eWdxand0eHlya25rZm9vend4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNzQwMzMsImV4cCI6MjA3MjY1MDAzM30.QnkZpgrVpfiEJaRcMuBVcJ9iasCPl0GLU99WSVl3q34';
    spSaveConfig();
  }
})();

/* ===== INIT ===== */
(async function init(){
  spLoadConfig(); await spInitClient(); if(sp.client && sp.session && sp.household_id){ spSubRealtime(); spSyncFromCloud('all'); }
  renderLista(); renderDashboard(); renderDemo(); renderCharts(); renderCalendar();
})();
</script>

</body>
</html>
