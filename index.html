<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Finan√ßas ‚Äî v16 (Auth Gate)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --bg:#0f172a; --panel:#111827; --card:#0b1220; --text:#e5e7eb; --muted:#9ca3af;
  --primary:#10b981; --accent:#22d3ee; --danger:#ef4444; --sidebar:#0b1220; --shadow: 0 10px 18px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--text);font-family:Inter,system-ui,Arial,sans-serif}
a{color:var(--accent);text-decoration:none}
small.muted{color:var(--muted)}
/* ===== Auth Gate ===== */
#gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at top, rgba(34,211,238,.08), transparent 60%), radial-gradient(ellipse at bottom, rgba(16,185,129,.08), transparent 60%), #0b1220;z-index:50}
.gcard{width:min(920px,92vw);background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
.ggrid{display:grid;grid-template-columns:1.3fr 1fr;gap:14px}
.gleft{border-right:1px dashed rgba(255,255,255,.08);padding-right:14px}
h1{margin:.2rem 0 .4rem 0}
h2{margin:.2rem 0 .6rem 0;font-size:16px}
label{font-size:12px;color:var(--muted)}
input,button,select,textarea{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);color:var(--text);padding:10px;border-radius:10px;width:100%}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn{cursor:pointer}
.btn.primary{background:var(--primary);border-color:var(--primary);color:#001b12;font-weight:600}
.stack{display:flex;flex-direction:column;gap:10px}
.badge{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18);color:var(--muted);font-size:12px;display:inline-flex;gap:6px;align-items:center}
.ok{color:#22c55e} .warn{color:#f59e0b} .err{color:#ef4444}
/* ===== App ===== */
.wrap{display:none;min-height:100vh}
aside{width:260px;background:var(--sidebar);padding:18px;position:sticky;top:0;height:100vh;border-right:1px solid rgba(255,255,255,.06)}
aside .logo{font-weight:700;letter-spacing:.5px;margin-bottom:18px;display:flex;align-items:center;gap:8px}
.nav a{display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:10px;color:var(--text);opacity:.85}
.nav a.active,.nav a:hover{background:rgba(255,255,255,.06);opacity:1}
.nav svg{width:18px;height:18px;opacity:.9}
main{flex:1;padding:22px}
.card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin:8px 0 6px}
.kpi{background:rgba(16,185,129,.09);border:1px solid rgba(16,185,129,.25);border-radius:16px;padding:14px;display:flex;align-items:center;gap:12px;min-height:78px}
.kpi .icon{width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center}
.kpi .val{font-weight:700;font-size:20px}
.kpi .label{color:var(--muted);font-size:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px 6px;text-align:left;font-size:13px}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cal .cell{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:10px;min-height:66px;padding:6px;position:relative}
.cal .day{position:absolute;top:6px;right:8px;color:var(--muted);font-size:11px}
.tag{display:inline-block;padding:2px 6px;border-radius:8px;font-size:10px}
.tag.exp{background:rgba(239,68,68,.18);border:1px solid rgba(239,68,68,.35)}
.tag.inc{background:rgba(34,197,94,.2);border:1px solid rgba(34,197,94,.4)}
aside.compact{width:76px}
aside.compact .txt{display:none}
.topbar{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.topbar .spacer{flex:1}
footer{margin-top:18px;text-align:right;color:var(--muted);font-size:12px}
</style>
</head>
<body>

<!-- ===== AUTH GATE ===== -->
<div id="gate">
  <div class="gcard">
    <div class="ggrid">
      <div class="gleft">
        <h1>Finan√ßas ‚Ä¢ <small class="muted">v16</small></h1>
        <p class="muted">Acesso restrito. Entre com e-mail e senha para visualizar o app.</p>
        <div id="stepCfg" class="stack" style="display:none">
          <h2>Conectar √† Nuvem (Supabase)</h2>
          <div class="row">
            <div class="stack"><label>Supabase URL</label><input id="gSpUrl" placeholder="https://xxxxx.supabase.co"/></div>
            <div class="stack"><label>Supabase anon key</label><input id="gSpKey" placeholder="eyJ..."/></div>
          </div>
          <div class="row">
            <button class="btn" id="gBtnTest">Testar</button>
            <button class="btn primary" id="gBtnSave">Salvar</button>
          </div>
          <div><span class="badge">Status: <span id="gStatus">offline</span></span></div>
        </div>

        <div id="stepAuth" class="stack" style="display:none">
          <h2>Entrar</h2>
          <div class="row">
            <div class="stack"><label>E-mail</label><input id="gEmail" type="email"/></div>
            <div class="stack"><label>Senha</label><input id="gPass" type="password"/></div>
          </div>
          <div class="row">
            <button class="btn primary" id="gLogin">Entrar</button>
            <button class="btn" id="gSignup">Criar conta</button>
            <button class="btn" id="gReset">Esqueci a senha</button>
          </div>
          <div><span class="badge">Cloud: <span id="gCloud">conectando...</span></span></div>
        </div>

        <div id="stepRecovery" class="stack" style="display:none">
          <h2>Definir nova senha</h2>
          <div class="row">
            <div class="stack"><label>Nova senha</label><input id="gNewPass" type="password"/></div>
            <div class="stack"><label>Confirmar</label><input id="gNewPass2" type="password"/></div>
          </div>
          <div><button class="btn primary" id="gSetPass">Salvar nova senha</button></div>
        </div>
      </div>

      <div>
        <h2>Status & ajuda</h2>
        <div class="stack">
          <div class="badge"><span>üîê</span> Sess√£o: <span id="gSess" class="warn">n√£o autenticado</span></div>
          <div class="badge"><span>üå©Ô∏è</span> Household: <code id="gHH">‚Äî</code></div>
          <small class="muted">Dica: em <strong>Supabase ‚Üí Authentication ‚Üí URL Configuration</strong>, adicione a URL <code id="siteUrl">https://seu-site.vercel.app</code> em ‚ÄúSite URL/Redirects‚Äù.</small>
          <small class="muted">Se o e-mail de confirma√ß√£o estiver ativo, o link ir√° voltar para esta tela e liberar o login.</small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== APP ===== -->
<div class="wrap" id="appWrap">
  <div style="display:flex">
    <aside id="sb">
      <div class="logo">
        <button id="btnCollapse" title="Recolher menu" style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:10px;width:36px;height:36px;display:flex;align-items:center;justify-content:center">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <span>Finan√ßas</span>
      </div>
      <nav class="nav">
        <a href="#dash" data-nav="dash" class="active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12h18M3 6h18M3 18h18"/></svg><span class="txt">Dashboard</span></a>
        <a href="#lancar" data-nav="lancar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 5v14M5 12h14"/></svg><span class="txt">Lan√ßar</span></a>
        <a href="#demo" data-nav="demo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><path d="M14.31 8l5.74 9.94M9.69 8h11.48M7.38 12l5.74-9.94M9.69 16L3.95 6.06"/></svg><span class="txt">Demonstrativo</span></a>
        <a href="#parc" data-nav="parc"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M3 10h18"/></svg><span class="txt">Parcelados</span></a>
        <a href="#cfg" data-nav="cfg"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h0A1.65 1.65 0 0 0 9 3.09V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h0a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v0A1.65 1.65 0 0 0 21 11h.09a2 2 0 1 1 0 4H21a1.65 1.65 0 0 0-1.51 1Z"/></svg><span class="txt">Config</span></a>
      </nav>
    </aside>

    <main>
      <div class="topbar">
        <div class="toolbar">
          <label>Per√≠odo:</label><select id="selMes"></select>
          <span class="pill mono"><span class="muted">Cloud:</span> <span id="pillCloudTxt">offline</span></span>
          <span class="pill mono" id="pillUser">usu√°rio: ‚Äî</span>
          <button class="btn" id="btnLogout">Sair</button>
        </div>
        <div class="spacer"></div>
      </div>

      <section id="dash" class="page">
        <div class="kpis">
          <div class="kpi"><div class="icon">üí∞</div><div><div class="label">Saldo estimado</div><div class="val" id="kSaldo">R$ 0,00</div></div></div>
          <div class="kpi"><div class="icon">üìâ</div><div><div class="label">Despesas</div><div class="val" id="kDesp">R$ 0,00</div></div></div>
          <div class="kpi"><div class="icon">üìà</div><div><div class="label">Receitas</div><div class="val" id="kRec">R$ 0,00</div></div></div>
          <div class="kpi"><div class="icon">üè¶</div><div><div class="label">Parcelados (m√™s)</div><div class="val" id="kParc">R$ 0,00</div></div></div>
        </div>

        <div class="row2">
          <div class="card">
            <h3>Resumo do m√™s</h3>
            <table class="table" id="tblResumo"></table>
          </div>
          <div class="card">
            <h3>Calend√°rio</h3>
            <div class="cal" id="cal"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Distribui√ß√£o das Despesas</h3>
          <canvas id="pie" height="160"></canvas>
          <h3 style="margin-top:12px">Evolu√ß√£o di√°ria ‚Ä¢ Despesas vs Receitas</h3>
          <canvas id="line" height="160"></canvas>
        </div>
        <footer>v16</footer>
      </section>

      <section id="lancar" class="page" style="display:none">
        <div class="card">
          <h3>Lan√ßar planejado (m√™s atual)</h3>
          <div class="row2">
            <div><label>Tipo</label><br/><select id="tipSel">
              <option value="fixas">Gastos Fixos</option>
              <option value="variaveis">Gastos Vari√°veis</option>
              <option value="invest">Investimentos</option>
              <option value="receitas">Receitas</option>
            </select></div>
            <div><label>Categoria</label><br/><select id="catSel"></select></div>
          </div>
          <div class="row2">
            <div><label>Subcategoria</label><br/><select id="subSel"></select></div>
            <div><label>Valor (R$)</label><br/><input id="valInp" type="number" step="0.01" placeholder="0,00"/></div>
          </div>
          <div class="toolbar" style="margin-top:8px">
            <button class="btn primary" id="btnAdd">Adicionar</button>
            <small class="muted">Os itens entram no m√™s selecionado acima.</small>
          </div>
        </div>

        <div class="card">
          <h3>Itens do m√™s</h3>
          <table class="table" id="tblItens"></table>
        </div>
      </section>

      <section id="demo" class="page" style="display:none">
        <div class="row2">
          <div class="card"><h3>Gastos Fixos</h3><table class="table" id="dFixas"></table></div>
          <div class="card"><h3>Gastos Vari√°veis</h3><table class="table" id="dVars"></table></div>
        </div>
        <div class="row2" style="margin-top:12px">
          <div class="card"><h3>Investimentos</h3><table class="table" id="dInv"></table></div>
          <div class="card"><h3>Receitas</h3><table class="table" id="dRec"></table></div>
        </div>
        <div class="card" style="margin-top:12px"><h3>Parcelados (m√™s)</h3><table class="table" id="dParc"></table></div>
      </section>

      <section id="parc" class="page" style="display:none">
        <div class="card">
          <h3>Novo contrato parcelado</h3>
          <div class="row2">
            <div><label>Descri√ß√£o</label><br/><input id="pcDesc" placeholder="Ex.: Financiamento carro"/></div>
            <div><label>In√≠cio</label><br/><input id="pcIni" type="date"/></div>
          </div>
          <div class="row2">
            <div><label>Dia de vencimento</label><br/><input id="pcDia" type="number" min="1" max="31" placeholder="10"/></div>
            <div><label>Valor da parcela (R$)</label><br/><input id="pcVal" type="number" step="0.01"/></div>
          </div>
          <div class="row2">
            <div><label>Quantidade de parcelas</label><br/><input id="pcQtd" type="number" min="1"/></div>
            <div style="display:flex;align-items:end"><button class="btn primary" id="btnPcAdd">Salvar contrato</button></div>
          </div>
        </div>
        <div class="card">
          <h3>Contratos</h3>
          <table class="table" id="tblContratos"></table>
        </div>
      </section>

      <section id="cfg" class="page" style="display:none">
        <div class="tabs">
          <button class="btn tab active" data-tab="tCateg">Categorias</button>
          <button class="btn tab" data-tab="tConta">Conta</button>
          <button class="btn tab" data-tab="tHH">Household</button>
        </div>

        <div id="tCateg" class="tabpane">
          <div class="card">
            <h3>Categorias & Subcategorias</h3>
            <small class="muted">Edite a lista. Cada linha √© uma categoria. Subcategorias separadas por v√≠rgula.</small>
            <div class="row2" style="margin-top:8px">
              <div>
                <label>Despesas (usado em Fixos e Vari√°veis)</label><br/>
                <textarea id="taDespesas" rows="8" style="width:100%"></textarea>
              </div>
              <div>
                <label>Subcategorias de Despesas</label><br/>
                <textarea id="taSubDespesas" rows="8" style="width:100%"></textarea>
              </div>
            </div>
            <div class="row2">
              <div>
                <label>Investimentos</label><br/>
                <textarea id="taInv" rows="4" style="width:100%"></textarea>
              </div>
              <div>
                <label>Receitas</label><br/>
                <textarea id="taRec" rows="4" style="width:100%"></textarea>
              </div>
            </div>
            <div class="toolbar">
              <button class="btn primary" id="btnSaveCfg">Salvar categorias</button>
              <span class="badge">As categorias ficam salvas localmente e, se logado no household, tamb√©m na nuvem.</span>
            </div>
          </div>
        </div>

        <div id="tConta" class="tabpane" style="display:none">
          <div class="card">
            <h3>Conta</h3>
            <div class="toolbar">
              <span class="badge">Usu√°rio: <span id="accEmail">‚Äî</span></span>
              <button class="btn" id="accLogout">Sair</button>
            </div>
          </div>
        </div>

        <div id="tHH" class="tabpane" style="display:none">
          <div class="card">
            <h3>Espa√ßo da fam√≠lia (Household)</h3>
            <div class="toolbar">
              <input id="joinId" placeholder="ID do Household" style="min-width:260px"/>
              <input id="joinPass" placeholder="Passcode"/>
              <button class="btn primary" id="btnJoinHH">Entrar com c√≥digo</button>
              <span class="pill"><span class="muted">Atual:</span> <code id="hhCurrent">‚Äî</code></span>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>
</div>

<script>
/* ===== utils ===== */
const brl = v => (v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

/* ===== state ===== */
let app = { atual: '', cfg:{ categorias:{despesas:[],investimentos:[],receitas:[]}, subcats:{despesas:[],investimentos:[],receitas:[]} }, meses:{}, diario:{}, parcelados:[] };
function saveLocal(){ localStorage.setItem('fin_app', JSON.stringify(app)); }
function loadLocal(){ try{ const j = JSON.parse(localStorage.getItem('fin_app')||'{}'); if(j && j.cfg) app = Object.assign(app, j); }catch(e){} }
loadLocal();

/* ===== Auth Gate logic ===== */
let sp = { url:'', key:'', client:null, session:null, household_id:null };
function spSaveConfig(){ localStorage.setItem('sp_cfg', JSON.stringify({url:sp.url, key:sp.key, household_id:sp.household_id, hh:sp.household_id})); }
function spLoadConfig(){ try{ const j = JSON.parse(localStorage.getItem('sp_cfg')||'{}'); sp.url=j.url||''; sp.key=j.key||''; sp.household_id=j.hh||j.household_id||null; }catch(e){} }
function setGateStatus(txt){ document.getElementById('gStatus').textContent = txt; }
function setCloudPill(txt){ document.getElementById('pillCloudTxt').textContent = txt; document.getElementById('gCloud').textContent = txt; }
function showStep(id){ ['stepCfg','stepAuth','stepRecovery'].forEach(s=>document.getElementById(s).style.display='none'); document.getElementById(id).style.display='block'; }
function showGate(){ document.getElementById('gate').style.display='flex'; document.getElementById('appWrap').style.display='none'; }
function showApp(){ document.getElementById('gate').style.display='none'; document.getElementById('appWrap').style.display='block'; }

async function spInit(){
  spLoadConfig();
  // prefill defaults (se n√£o configurado ainda)
  if(!sp.url){ sp.url='https://uvygqjwtxyrknkfoozwx.supabase.co'; }
  if(!sp.key){ sp.key='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2eWdxand0eHlya25rZm9vend4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNzQwMzMsImV4cCI6MjA3MjY1MDAzM30.QnkZpgrVpfiEJaRcMuBVcJ9iasCPl0GLU99WSVl3q34'; }
  sp.client = window.supabase.createClient(sp.url, sp.key);
  const { data } = await sp.client.auth.getSession();
  sp.session = data?.session||null;
  setCloudPill(sp.session ? (sp.household_id?'online ‚úì':'logado (sem household)') : 'conectado (sem login)');
  // Roteia step do Gate
  document.getElementById('gSpUrl').value = sp.url;
  document.getElementById('gSpKey').value = sp.key;
  document.getElementById('siteUrl').textContent = location.origin;
  if(window.location.hash.includes('type=recovery') || window.location.href.includes('access_token')){
    showGate(); showStep('stepRecovery'); return;
  }
  if(!sp.session){ showGate(); showStep('stepAuth'); return; }
  // ok logado
  showApp();
  document.getElementById('pillUser').textContent = 'usu√°rio: '+(sp.session.user.email||'‚Äî');
  document.getElementById('accEmail').textContent = sp.session.user.email||'‚Äî';
  document.getElementById('hhCurrent').textContent = sp.household_id||'‚Äî';
  // render app
  initAppUI();
}
/* Gate buttons */
document.getElementById('gBtnSave').onclick = async ()=>{
  sp.url = document.getElementById('gSpUrl').value.trim();
  sp.key = document.getElementById('gSpKey').value.trim();
  spSaveConfig(); setGateStatus('salvo'); await spInit();
};
document.getElementById('gBtnTest').onclick = async ()=>{
  try{
    const test = window.supabase.createClient(document.getElementById('gSpUrl').value.trim(), document.getElementById('gSpKey').value.trim());
    const { error } = await test.from('households').select('id').limit(1);
    setGateStatus(error ? 'conectado (RLS ativo)' : 'online ‚úì');
  }catch(e){ setGateStatus('offline'); alert('Erro ao testar: '+e.message); }
};
document.getElementById('gLogin').onclick = async ()=>{
  try{
    const { data, error } = await sp.client.auth.signInWithPassword({ email: document.getElementById('gEmail').value.trim(), password: document.getElementById('gPass').value });
    if(error) throw error;
    sp.session = data.session; setCloudPill(sp.household_id?'online ‚úì':'logado (sem household)');
    showApp(); document.getElementById('pillUser').textContent = 'usu√°rio: '+(sp.session.user.email||'‚Äî');
    initAppUI();
  }catch(e){ alert('Erro ao entrar: '+e.message); }
};
document.getElementById('gSignup').onclick = async ()=>{
  try{
    const { data, error } = await sp.client.auth.signUp({ email: document.getElementById('gEmail').value.trim(), password: document.getElementById('gPass').value });
    if(error) throw error;
    alert('Conta criada! Verifique e-mail se a confirma√ß√£o estiver ativa.');
  }catch(e){ alert('Erro ao criar conta: '+e.message); }
};
document.getElementById('gReset').onclick = async ()=>{
  try{
    const email = document.getElementById('gEmail').value.trim();
    if(!email){ alert('Informe o e-mail para recuperar.'); return; }
    await sp.client.auth.resetPasswordForEmail(email, { redirectTo: location.origin+'/#type=recovery' });
    alert('Se o e-mail existir, voc√™ receber√° um link para redefinir a senha.');
  }catch(e){ alert('Erro: '+e.message); }
};
document.getElementById('gSetPass').onclick = async ()=>{
  try{
    const p1 = document.getElementById('gNewPass').value, p2 = document.getElementById('gNewPass2').value;
    if(!p1 || p1!==p2){ alert('Senhas n√£o conferem.'); return; }
    const { data, error } = await sp.client.auth.updateUser({ password: p1 });
    if(error) throw error; alert('Senha alterada! Fa√ßa login.'); showStep('stepAuth');
  }catch(e){ alert('Erro: '+e.message); }
};

/* ===== App UI behavior (s√≥ ap√≥s login) ===== */
function initAppUI(){
  // sidebar
  const sb = document.getElementById('sb');
  document.getElementById('btnCollapse').onclick = ()=>{ sb.classList.toggle('compact'); localStorage.setItem('sb_compact', sb.classList.contains('compact')?'1':'0'); };
  if(localStorage.getItem('sb_compact')==='1') sb.classList.add('compact');
  document.querySelectorAll('.nav a').forEach(a=>a.onclick=(e)=>{ e.preventDefault(); document.querySelectorAll('.nav a').forEach(n=>n.classList.remove('active')); a.classList.add('active'); document.querySelectorAll('.page').forEach(p=>p.style.display='none'); document.querySelector(a.getAttribute('href')).style.display='block'; });
  // m√™s
  const sel=document.getElementById('selMes'); sel.innerHTML=''; const base=new Date(); base.setDate(1);
  for(let i=-5;i<=7;i++){ const dt=new Date(base.getFullYear(), base.getMonth()+i, 1); const v=dt.toISOString().slice(0,7); const o=document.createElement('option'); o.value=v;o.textContent=v;if(i===0)o.selected=true; sel.appendChild(o); }
  app.atual = sel.value;
  sel.onchange = ()=>{ app.atual=sel.value; saveLocal(); renderLista(); renderDashboard(); renderDemo(); renderCharts(); };
  // categorias default
  if(!app.cfg.categorias.despesas.length){ app.cfg={ categorias:{ despesas:["Alimenta√ß√£o","Moradia","Transporte","Sa√∫de","Educa√ß√£o","Lazer","Contas","Outros"], investimentos:["Reserva Emerg√™ncia","Aportes","Poupan√ßa"], receitas:["Sal√°rio","Pr√≥-labore","Bicos","Outras"] }, subcats:{ despesas:["Supermercado","Restaurante","Delivery","Aluguel","Condom√≠nio","Luz","√Ågua","Internet","Combust√≠vel","Manuten√ß√£o","Farm√°cia","Plano de Sa√∫de"], investimentos:["Tesouro","CDB","Fundos","A√ß√µes"], receitas:["Principal","13¬∫","B√¥nus"] } }; }
  // forms
  function renderForm(){
    const t=document.getElementById('tipSel').value;
    const cat = t==='invest'? app.cfg.categorias.investimentos : (t==='receitas'? app.cfg.categorias.receitas : app.cfg.categorias.despesas);
    document.getElementById('catSel').innerHTML = cat.map(x=>`<option>${x}</option>`).join('');
    const subs = t==='invest'? (app.cfg.subcats.investimentos||[]) : (t==='receitas'? (app.cfg.subcats.receitas||[]) : app.cfg.subcats.despesas);
    document.getElementById('subSel').innerHTML = subs.map(x=>`<option>${x}</option>`).join('');
  }
  document.getElementById('tipSel').onchange = renderForm; renderForm();

  // lista m√™s
  function renderLista(){
    const list = app.meses[app.atual]||[];
    const el = document.getElementById('tblItens');
    const rows = list.map((x,i)=>`<tr><td><span class="badge">${x.tipo}</span></td><td>${x.categoria||''}</td><td>${x.subcategoria||''}</td><td>${brl(x.valor)}</td><td><button class="btn" data-del="${i}">Excluir</button></td></tr>`).join('');
    el.innerHTML = `<tr><th>Tipo</th><th>Categoria</th><th>Subcategoria</th><th>Valor</th><th></th></tr>${rows}`;
    el.querySelectorAll('button[data-del]').forEach(b=>b.onclick=()=>{ const idx=+b.dataset.del; (app.meses[app.atual]||[]).splice(idx,1); saveLocal(); renderLista(); renderDashboard(); renderDemo(); renderCharts(); });
  }
  window.renderLista = renderLista;

  // add
  document.getElementById('btnAdd').onclick = async ()=>{
    const t=document.getElementById('tipSel').value, c=document.getElementById('catSel').value, s=document.getElementById('subSel').value, v=parseFloat(document.getElementById('valInp').value||'0');
    if(!v||v<=0){ alert('Informe um valor.'); return; }
    app.meses[app.atual]=app.meses[app.atual]||[]; app.meses[app.atual].push({tipo:t,categoria:c,subcategoria:s,valor:v}); saveLocal(); renderLista(); renderDashboard(); renderDemo(); renderCharts();
    if(sp.client && sp.session && sp.household_id){ await sp.client.from('transactions').insert({ household_id:sp.household_id, ref_month:app.atual, tipo:t, categoria:c, subcategoria:s, valor:v }); }
  };

  // dashboard
  function calcResumo(){
    const arr=app.meses[app.atual]||[]; let fix=0,varv=0,inv=0,rec=0;
    arr.forEach(x=>{ if(x.tipo==='fixas') fix+=x.valor; else if(x.tipo==='variaveis') varv+=x.valor; else if(x.tipo==='invest') inv+=x.valor; else if(x.tipo==='receitas') rec+=x.valor; });
    let parcMes=0; const m=app.atual;
    app.parcelados.forEach(ct=>{ for(let i=0;i<ct.qtd_parcelas;i++){ const d=new Date(ct.data_ini); d.setMonth(d.getMonth()+i); const venc=new Date(d.getFullYear(), d.getMonth(), ct.venc_dia); const mk=venc.toISOString().slice(0,7); if(mk===m) parcMes += +ct.valor_parcela; } });
    return {fix,varv,inv,rec,parcMes, saldo:(rec-(fix+varv+parcMes+inv))};
  }
  function renderDashboard(){
    const r=calcResumo();
    document.getElementById('kSaldo').textContent=brl(r.saldo);
    document.getElementById('kDesp').textContent =brl(r.fix+r.varv+r.parcMes+r.inv);
    document.getElementById('kRec').textContent  =brl(r.rec);
    document.getElementById('kParc').textContent =brl(r.parcMes);
    const tbl=document.getElementById('tblResumo');
    tbl.innerHTML = `<tr><th>Grupo</th><th>Total</th></tr>
    <tr><td>Fixos</td><td>${brl(r.fix)}</td></tr>
    <tr><td>Vari√°veis</td><td>${brl(r.varv)}</td></tr>
    <tr><td>Parcelados (m√™s)</td><td>${brl(r.parcMes)}</td></tr>
    <tr><td>Investimentos</td><td>${brl(r.inv)}</td></tr>
    <tr><td>Receitas</td><td>${brl(r.rec)}</td></tr>
    <tr><td><b>Saldo</b></td><td><b>${brl(r.saldo)}</b></td></tr>`;
    renderCalendar();
  }
  window.renderDashboard = renderDashboard;

  // calendar
  function renderCalendar(){
    const base=new Date(app.atual+'-01T00:00:00'); const start=new Date(base.getFullYear(),base.getMonth(),1); const end=new Date(base.getFullYear(),base.getMonth()+1,0); const pad=(start.getDay()+6)%7;
    const cells=[]; for(let i=0;i<pad;i++) cells.push('<div></div>');
    for(let d=1; d<=end.getDate(); d++){ const k=app.atual+'-'+String(d).padStart(2,'0'); const list=app.diario[k]||[]; const gDesp=list.filter(x=>x.tipo!=='receitas' && x.tipo!=='invest').reduce((a,b)=>a+b.valor,0); const gRec=list.filter(x=>x.tipo==='receitas').reduce((a,b)=>a+b.valor,0);
      cells.push(`<div class="cell" data-day="${k}"><div class="day">${d}</div>${gDesp?`<span class="tag exp">- ${brl(gDesp)}</span>`:''}${gRec?` <span class="tag inc">+ ${brl(gRec)}</span>`:''}</div>`);
    }
    const el=document.getElementById('cal'); el.innerHTML=cells.join('');
  }
  window.renderCalendar = renderCalendar;

  // demo
  function group(list){ return list.reduce((acc,x)=>{ const k=(x.categoria||'‚Äî')+' / '+(x.subcategoria||'‚Äî'); acc[k]=(acc[k]||0)+x.valor; return acc; },{}); }
  function tableFromGroup(g){ const rows=Object.entries(g).map(([k,v])=>`<tr><td>${k}</td><td>${brl(v)}</td></tr>`).join(''); return `<tr><th>Categoria / Sub</th><th>Total</th></tr>${rows||''}`; }
  function renderDemo(){
    const arr=app.meses[app.atual]||[];
    document.getElementById('dFixas').innerHTML = tableFromGroup(group(arr.filter(x=>x.tipo==='fixas')));
    document.getElementById('dVars').innerHTML  = tableFromGroup(group(arr.filter(x=>x.tipo==='variaveis')));
    document.getElementById('dInv').innerHTML   = tableFromGroup(group(arr.filter(x=>x.tipo==='invest')));
    document.getElementById('dRec').innerHTML   = tableFromGroup(group(arr.filter(x=>x.tipo==='receitas')));
    const r=calcResumo(); document.getElementById('dParc').innerHTML = `<tr><th>Parcela do m√™s</th><th>Total</th></tr><tr><td>Somat√≥rio</td><td>${brl(r.parcMes)}</td></tr>`;
  }
  window.renderDemo = renderDemo;

  // charts
  let pie=null,line=null;
  function renderCharts(){
    const arr=app.meses[app.atual]||[]; const somaPorCat={}; arr.filter(x=>x.tipo!=='receitas' && x.tipo!=='invest').forEach(x=>{ somaPorCat[x.categoria]=(somaPorCat[x.categoria]||0)+x.valor; });
    const pctx=document.getElementById('pie').getContext('2d'); if(pie) pie.destroy(); pie=new Chart(pctx,{type:'pie',data:{labels:Object.keys(somaPorCat),datasets:[{data:Object.values(somaPorCat)}]}});
    // di√°rio
    const days=[], dDesp=[], dRec=[]; const base=new Date(app.atual+'-01T00:00:00'); const end=new Date(base.getFullYear(),base.getMonth()+1,0);
    for(let d=1; d<=end.getDate(); d++){ const k=app.atual+'-'+String(d).padStart(2,'0'); days.push(d); const list=app.diario[k]||[]; dDesp.push(list.filter(x=>x.tipo!=='receitas').reduce((a,b)=>a+b.valor,0)); dRec.push(list.filter(x=>x.tipo==='receitas').reduce((a,b)=>a+b.valor,0)); }
    const lctx=document.getElementById('line').getContext('2d'); if(line) line.destroy(); line=new Chart(lctx,{type:'line',data:{labels:days,datasets:[{label:'Despesas',data:dDesp},{label:'Receitas',data:dRec}]}});
  }
  window.renderCharts = renderCharts;

  // save categorias
  document.getElementById('btnSaveCfg').onclick = ()=>{
    app.cfg.categorias.despesas = document.getElementById('taDespesas').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    app.cfg.subcats.despesas     = document.getElementById('taSubDespesas').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    app.cfg.categorias.investimentos = document.getElementById('taInv').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    app.cfg.categorias.receitas = document.getElementById('taRec').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    saveLocal(); alert('Categorias salvas.');
  };

  // logout
  document.getElementById('btnLogout').onclick = async ()=>{ await sp.client.auth.signOut(); sp.session=null; showGate(); showStep('stepAuth'); setCloudPill('conectado (sem login)'); };
  document.getElementById('accLogout').onclick = ()=> document.getElementById('btnLogout').click();

  // render init
  renderLista(); renderDashboard(); renderDemo(); renderCharts();
}

/* ===== start ===== */
spInit();
</script>
</body>
</html>
